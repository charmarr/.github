name: Publish Charm to Edge

on:
  workflow_call:
    inputs:
      charm-path:
        description: Path to charm directory (use "." for standalone repos)
        type: string
        default: "."
      track:
        description: Charmhub track (e.g., "latest", "1", "2")
        type: string
        default: "latest"
      run-integration:
        description: Run integration tests before publishing
        type: boolean
        default: true
      tag-terraform:
        description: Auto-tag terraform module if VERSION changed
        type: boolean
        default: true
      dry-run:
        description: Skip actual publish (for testing)
        type: boolean
        default: false
      extra-debs:
        description: Additional apt packages for integration tests (comma-separated)
        type: string
        default: ""
      substrate:
        description: K8s substrate (microk8s or k8s)
        type: string
        default: "microk8s"
      substrate-channel:
        description: Substrate snap channel
        type: string
        default: "1.32-strict/stable"
      automatically-retry-hooks:
        description: Whether Juju should automatically retry failed hooks
        type: boolean
        default: true
      integration-runner:
        description: Runner for integration tests (e.g., "ubuntu-latest" or self-hosted tag)
        type: string
        default: "ubuntu-latest"
    secrets:
      CHARMHUB_TOKEN:
        required: true

concurrency:
  group: publish-${{ github.ref }}-${{ inputs.charm-path }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Charm
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.artifact-name.outputs.name }}
    steps:
      - uses: actions/checkout@v4

      - uses: charmarr/.github/actions/charm/setup@v1
        with:
          lxd: "true"

      - id: artifact-name
        shell: bash
        run: |
          if [[ "${{ inputs.charm-path }}" == "." ]]; then
            echo "name=charm-${{ github.event.repository.name }}" >> "$GITHUB_OUTPUT"
          else
            echo "name=charm-$(echo '${{ inputs.charm-path }}' | tr '/' '-')" >> "$GITHUB_OUTPUT"
          fi

      - uses: charmarr/.github/actions/charm/build@v1
        with:
          charm-path: ${{ inputs.charm-path }}
          artifact-name: ${{ steps.artifact-name.outputs.name }}

  integration-matrix:
    name: Define integration matrix
    needs: build
    if: inputs.run-integration
    runs-on: ubuntu-latest
    outputs:
      suites: ${{ steps.suites.outputs.suites }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate matrix
        id: suites
        working-directory: ${{ inputs.charm-path }}
        run: |
          if [[ -d "tests/integration" ]]; then
            list="$(find tests/integration -name 'test_*.py' -printf '%f\n' | jq -R -n -c '[inputs]')"
          else
            list="[]"
          fi
          echo "suites=$list" >> "$GITHUB_OUTPUT"

  integration:
    name: Integration (${{ matrix.suite }})
    needs: [build, integration-matrix]
    if: inputs.run-integration && needs.integration-matrix.outputs.suites != '[]'
    runs-on: ${{ inputs.integration-runner }}
    strategy:
      fail-fast: false
      matrix:
        suite: ${{ fromJSON(needs.integration-matrix.outputs.suites) }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ${{ inputs.charm-path }}

      - name: Clean runner caches
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

      - uses: charmarr/.github/actions/charm/setup@v1
        with:
          juju: "true"
          extra-debs: ${{ inputs.extra-debs }}
          substrate: ${{ inputs.substrate }}
          substrate-channel: ${{ inputs.substrate-channel }}
          automatically-retry-hooks: ${{ inputs.automatically-retry-hooks }}

      - name: Run integration tests
        working-directory: ${{ inputs.charm-path }}
        run: |
          set -euo pipefail
          charm_file="$(find . -maxdepth 1 -name '*.charm' -print -quit)"
          if [[ -z "$charm_file" ]]; then
            echo "::error::No .charm file found"
            exit 1
          fi
          export CHARM_PATH
          CHARM_PATH="$(realpath "$charm_file")"
          uvx tox -e integration -- -k "${{ matrix.suite }}"

  publish:
    name: Publish to Edge
    needs: [build, integration-matrix, integration]
    if: always() && needs.build.result == 'success' && (needs.integration.result == 'success' || needs.integration.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: charmarr/.github/actions/charm/setup@v1

      - uses: charmarr/.github/actions/charm/publish@v1
        with:
          charm-path: ${{ inputs.charm-path }}
          channel: ${{ inputs.track }}/edge
          artifact-name: ${{ needs.build.outputs.artifact-name }}
          dry-run: ${{ inputs.dry-run }}
        env:
          CHARMHUB_TOKEN: ${{ secrets.CHARMHUB_TOKEN }}

  tag-terraform:
    name: Tag Terraform Module
    needs: publish
    if: inputs.tag-terraform
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: charmarr/.github/actions/charm/setup@v1
        with:
          charmcraft: "false"

      - uses: charmarr/.github/actions/charm/tag-terraform@v1
        with:
          charm-path: ${{ inputs.charm-path }}
          dry-run: ${{ inputs.dry-run }}
